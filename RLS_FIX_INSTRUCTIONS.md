# Исправление ошибки RLS (Row Level Security)

## Проблема

При регистрации возникает ошибка:
```
new row violates row-level security policy for table "subscription_users"
```

Это происходит потому, что таблицы в Supabase имеют RLS (Row Level Security), но политики не разрешают INSERT через анонимный ключ.

## Решение

### Шаг 1: Откройте Supabase SQL Editor

1. Зайдите в Supabase Dashboard: https://supabase.com
2. Выберите проект FaloClaro
3. Перейдите в **SQL Editor** (в левом меню)
4. Нажмите **"New query"**

### Шаг 2: Выполните SQL скрипт

1. Откройте файл `database/fix-subscription-rls.sql`
2. Скопируйте весь SQL код
3. Вставьте в SQL Editor в Supabase
4. Нажмите **"Run"** или `Cmd+Enter` / `Ctrl+Enter`

### Шаг 3: Проверка

После выполнения скрипта:

1. Попробуйте зарегистрироваться снова на https://www.faloclaro.com/pt
2. Ошибка должна исчезнуть
3. Проверьте логи в Vercel - не должно быть ошибок RLS

## Что делает скрипт

Скрипт добавляет RLS политики, которые разрешают:

- ✅ **INSERT** в `subscription_users` (регистрация)
- ✅ **SELECT** из `subscription_users` (проверка существования)
- ✅ **INSERT/UPDATE/SELECT** для `subscriptions` (создание подписки)
- ✅ **INSERT/SELECT/UPDATE** для `lesson_access_tokens` (токены доступа)
- ✅ **INSERT** для `email_logs` (логи писем)
- ✅ **INSERT/UPDATE/SELECT** для `user_progress` и `task_progress` (прогресс)

## Безопасность

Для production можно добавить более строгие политики, которые проверяют:
- Что пользователь может обновлять только свой прогресс
- Что токены проверяются перед использованием

Но для MVP текущие политики достаточны, так как:
- Мы используем уникальные токены для доступа к урокам
- Email служит идентификатором пользователя
- Нет чувствительных данных, требующих строгой защиты

## Альтернативное решение (не рекомендуется)

Если не хотите использовать публичные политики, можно:
1. Использовать Service Role Key в API routes
2. Но это менее безопасно, так как ключ будет в коде

Текущее решение с RLS политиками более безопасно и правильное.


